<?php

namespace Cbi\MalwareChecker;

use Cbi\MalwareChecker\Response;
use Cbi\MalwareChecker\ResponseFactory;

class MalwareChecker
{
    /**
     * Check a single hash using the DNS protocol
     * @param  string $hash The hash to check
     * @return Response
     */
    public function check(string $hash) : Response
    {
        $dnsResponse = dns_get_record($hash.'.malware.hash.cymru.com', DNS_TXT);

        if(count($dnsResponse) == 0) {
            return ResponseFactory::make($hash);
        }

        $hashData = explode(' ', $dnsResponse[0]['txt']);
        return ResponseFactory::make($hash, $hashData[0], $hashData[1]);
    }

    /**
     * Check multiple hashes using the whois protocol
     * @param  array  $hashes The hashes to check
     * @return array         An array of responses
     */
    public function checkMany(array $hashes) : array
    {
        $start = microtime(true);
        $whoisResponse = '';
        // Open a Socket connection to our WHOIS server
        $fp = fsockopen("hash.cymru.com", 43);

        // Send the data
        fwrite($fp, "begin\r\n" . implode("\r\n",$hashes) . "end\r\n");

        // Listen for data and "append" all the bits of information to
        // our result variable until the data stream is finished
        while (!feof($fp)) {
            $whoisResponse .= fgets($fp);
        }

        // Close the connection
        fclose($fp);

        // Explode the whois response and slice the excess
        $individualHashResponses = array_slice(explode("\n", $whoisResponse), 2, -1);
        $totalHashes = count($individualHashResponses);

        // Iterate the individual responses and add the response object to the return array
        for ($i=0; $i < $totalHashes; $i++) {
            $hashFields = explode(' ', $individualHashResponses[$i]);
            $responses[] = ResponseFactory::make($hashFields[0], $hashFields[1], $hashFields[2]);
        }

        return $responses;
    }
}

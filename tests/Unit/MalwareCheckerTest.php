<?php
namespace Cbi\MalwareChecker\Tests\Unit;

use PHPUnit\Framework\TestCase;
use Cbi\MalwareChecker\MalwareChecker;

class MalwareCheckerTest extends TestCase
{
    protected $safeHash;
    protected $infectedHash;

    /**
     * {@inheritdoc}
     */
    public function setUp()
    {
        parent::setUp();
        $this->safeHash = 'ebbd225e6fd4eaa7189423a4b17065b3';
        $this->infectedHash = 'ff18f8db4f08718ee44fa1a389c0b5d7';
    }

    /**
     * The check function returns an array if the hash is infected
     */
    public function testCheckFunctionReturnsArrayOnInfectedHash()
    {
        $infectedResponse = MalwareChecker::check($this->infectedHash);

        $this->assertTrue(is_array($infectedResponse));
    }

    /**
     * The check function returns false if the hash is safe
     */
    public function testCheckFunctionReturnsFalseOnSafeHash()
    {
        $safeResponse = MalwareChecker::check($this->safeHash);

        $this->assertFalse($safeResponse);
    }

    /**
     * The check many function returns only the infected hashes
     */
    public function testCheckManyFunctionOnlyReturnsInfectedHashes()
    {
        $whoisResponse = MalwareChecker::checkMany([$this->infectedHash, $this->safeHash]);

        $this->assertCount(1, $whoisResponse);
        $this->assertContains($this->infectedHash, $whoisResponse[0]);
    }

    /**
     * The check many function returns false if all hashes are safe
     */
    public function testCheckManyFunctionReturnsFalseIfAllHashesAreSafe()
    {
        $whoisResponse = MalwareChecker::checkMany([$this->safeHash, $this->safeHash]);

        $this->assertFalse($whoisResponse);
    }

    /**
     * The makeHash functions returns the correct hash of a file
     */
    public function testMakeHashFunctionReturnsTheCorrectHash()
    {
        $resource = fopen('tests/stubs/test.txt', 'rw');
        $uri = 'tests/stubs/test.txt';
        $md5 = 'fea80f2db003d4ebc4536023814aa885';

        $this->assertEquals(MalwareChecker::makeHash($resource), $md5);
        $this->assertEquals(MalwareChecker::makeHash($uri), $md5);
    }

    /**
     * The makeHashes functions returns the correct hashes of a file
     */
    public function testMakeHashesFunctionReturnsTheCorrectArrayOfHashes()
    {
        $resource = fopen('tests/stubs/test.txt', 'rw');
        $uri = 'tests/stubs/test.txt';
        $md5 = 'fea80f2db003d4ebc4536023814aa885';
        $sha1 = '38f00f8738e241daea6f37f6f55ae8414d7b0219';
        $sha256 = '16aba5393ad72c0041f5600ad3c2c52ec437a2f0c7fc08fadfc3c0fe9641d7a3';
        $hashes = [$md5, $sha1, $sha256];

        $this->assertEquals(MalwareChecker::makeHashes($resource), $hashes);
        $this->assertEquals(MalwareChecker::makeHashes($uri), $hashes);
    }
}
